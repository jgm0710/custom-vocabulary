<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Shared Vocabulary</title>
</head>
<body>
<th:block th:include="fragments/header"/>
<div class="card">
    <div class="card-header">
        Profile
    </div>
    <ul class="list-group list-group-flush">
        <li class="list-group-item">
            <div class="row">
                <div class="col">No.</div>
                <input id="memberId" class="col-10 custom-text-box read-toggle" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">Login ID</div>
                <input id="joinId" class="col-10 custom-text-box read-toggle" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">Email</div>
                <input id="email" class="col-10 custom-text-box read-toggle" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">name</div>
                <input id="name" class="col-10 custom-text-box read-toggle" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">Nickname</div>
                <input id="nickname" class="col-10 custom-text-box read-toggle" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div id="textDateOfBirth">
                <div class="row">
                    <div class="col-2">생년월일</div>
                    <input id="dateOfBirth" class="col custom-text-box" type="text" readonly>
                </div>
            </div>

            <div id="selectDateOfBirth" style="display: none">
                <div class="row">
                    <div class="col-2">
                        <span class="custom-span">생년월일</span>
                    </div>
                    <div class="col-md-auto">
                        <select name="year"
                                class="form-select form-select-sm"
                                aria-label=".form-select-sm example">
                            <option selected value="-1">year</option>
                            <th:block th:each="num: ${years}">
                                <option th:value="${num}" th:text="${num}" value="1"></option>
                            </th:block>
                        </select>
                    </div>
                    <div class="col-md-auto">
                        <select name="month"
                                class="form-select form-select-sm"
                                aria-label=".form-select-sm example">
                            <option selected value="-1">month</option>
                            <th:block th:each="month: ${month}">
                                <option th:value="${month.value}" th:text="${month.text}"
                                        value="1"></option>
                            </th:block>
                        </select>
                    </div>
                    <div class="col-md-auto">
                        <select name="day"
                                class="form-select form-select-sm"
                                aria-label=".form-select-sm example">
                            <option selected value="-1">day</option>
                            <th:block th:each="day: ${days}">
                                <option th:value="${day.value}" th:text="${day.text}"
                                        value="1"></option>
                            </th:block>
                        </select>
                    </div>
                </div>
            </div>
        </li>
        <li class="list-group-item">
            <div id="textGender">
                <div class="row">
                    <div class="col">성별</div>
                    <input id="gender" class="col-10 custom-text-box" type="text" readonly>
                    <div style="display: none">
                        <input class="col-10 custom-text-box" type="text" readonly>
                    </div>
                </div>
            </div>

            <div id="selectGender" style="display: none">
                <div class="row">
                    <div class="col-2">
                        <span class="custom-span">성별</span>
                    </div>
                    <div class="col-md-auto">
                        <select name="gender"
                                class="form-select form-select-sm"
                                aria-label=".form-select-sm example">
                            <option selected value="-1">Gender</option>
                            <option th:value="MALE" th:text="남성" value="MALE"></option>
                            <option th:value="FEMALE" th:text="여성" value="FEMALE"></option>
                        </select>
                    </div>
                </div>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">Simple Address</div>
                <input id="simpleAddress" class="col-10 custom-text-box read-toggle" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">공유한 단어장 수</div>
                <input id="sharedVocabularyCount" class="col-10 custom-text-box" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">작성한 게시글 수</div>
                <input id="bbsCount" class="col-10 custom-text-box" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">가입일시</div>
                <input id="registerDate" class="col-10 custom-text-box" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">개인정보 최종 수정일시</div>
                <input id="updateDate" class="col-10 custom-text-box" type="text" readonly>
            </div>
        </li>
    </ul>
</div>
<div id="custom-button-group" style="margin-top: 10px">
    <input id="modify-btn" type="button" value="Modify" class="btn btn-outline-warning">
    <input id="withdrawal-btn" type="button" value="Withdrawal" class="btn btn-outline-danger" data-bs-toggle="modal"
           data-bs-target="#withdrawalConfirmationModal">
    <input id="update-password-btn" type="button" class="btn btn-outline-secondary" value="Update password"
           data-bs-toggle="modal"
           data-bs-target="#updatePasswordModal">
    <input id="cancel-btn" type="hidden" value="Cancel" class="btn btn-outline-warning">
    <input id="confirm-btn" type="hidden" class="btn btn-outline-success" value="Confirm" data-bs-toggle="modal"
           data-bs-target="#modifyConfirmationModal">
</div>

<!-- Modify confirmation modal -->
<div class="modal fade" id="modifyConfirmationModal" tabindex="-1" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">프로필 수정 본인인증</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                본인 확인을 위한 비밀번호를 입력해주세요.
            </div>
            <div class="input-group input-group-sm mb-3">
                <input id="modifyConfirmPassword" type="password" class="form-control ml-3 mr-3"
                       aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="modify-confirm-btn" type="button" class="btn btn-primary">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Withdrawal confirmation modal -->
<div class="modal fade" id="withdrawalConfirmationModal" tabindex="-1" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel2">회원탈퇴 본인인증</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                본인 확인을 위한 비밀번호를 입력해주세요.
            </div>
            <div class="input-group input-group-sm mb-3">
                <input id="withdrawalConfirmPassword" type="password" class="form-control ml-3 mr-3"
                       aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="withdrawal-confirm-btn" type="button" class="btn btn-primary">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Update password modal -->
<div class="modal fade" id="updatePasswordModal" tabindex="-1" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel3">비밀번호 변경 본인인증</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                변경할 비밀번호를 입력하세요.
            </div>
            <div class="input-group input-group-sm mb-3">
                <input id="newPassword" type="password" class="form-control ml-3 mr-3"
                       aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
            </div>
            <div class="modal-body" style="padding-top: 0px;">
                변경할 비밀번호를 다시 입력하세요.
            </div>
            <div class="input-group input-group-sm mb-3">
                <input id="newPasswordConfirm" type="password" class="form-control ml-3 mr-3"
                       aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
            </div>
            <div class="modal-body">
                본인 확인을 위한 기존 비밀번호를 입력해주세요.
            </div>
            <div class="input-group input-group-sm mb-3">
                <input id="updatePasswordConfirmPassword" type="password" class="form-control ml-3 mr-3"
                       aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="update-password-confirm-btn" type="button" class="btn btn-primary">Confirm</button>
            </div>
        </div>
    </div>
</div>

<th:block th:include="fragments/footer"/>

<script th:src="@{/custom/profile.js}"></script>
<script>
    $(document).ready(function () {

        let tokenInfo = getTokenInfo();

        if (tokenInfo.accessToken == null) {
            $(location).attr('href', '/');
            localStorage.clear();
            alert("인증되지 않은 회원은 프로필에 접근할 수 없습니다.");
        }

        let profile = getProfile(tokenInfo.memberId, tokenInfo.accessToken, tokenInfo.refreshToken);

        fillInProfile(profile);

        $('#modify-btn').click(function () {
            switchToModifyMode();
        });

        $('#cancel-btn').click(function () {
            switchToNormalMode();
            fillInProfile(profile);
        });

        $('#modify-confirm-btn').click(function () {
            let updateDto = getUpdateDto();
            modifyProfile(tokenInfo.memberId, tokenInfo.accessToken, tokenInfo.refreshToken, updateDto);
        });

        $('#withdrawal-confirm-btn').click(function () {
            console.log("Click withdrawal confirm button.");
            const confirmPassword = $('#withdrawalConfirmPassword').val();
            if (checkExistConfirmPassword(confirmPassword)) {
                withdrawal(tokenInfo.memberId, tokenInfo.accessToken, tokenInfo.refreshToken, confirmPassword);
            }
        });

        $('#update-password-confirm-btn').click(function () {
            console.log("Click update password confirm button.");
            let passwordValues = getPasswordValues();
            let possibleFlag = checkIfPasswordUpdateIsPossible(passwordValues.newPassword, passwordValues.newPasswordConfirm, passwordValues.updatePasswordConfirmPassword);

            if (possibleFlag) {
                console.log("Try update password!!");
                updatePassword(tokenInfo.memberId, tokenInfo.accessToken+"i", tokenInfo.refreshToken, passwordValues.newPassword, passwordValues.updatePasswordConfirmPassword);
            }
        });

    });

    function updatePassword(memberId, accessToken, refreshToken, newPassword, oldPassword) {
        const passwordUpdateDto = {
            newPassword: newPassword,
            oldPassword: oldPassword
        }

        $.ajax({
            method: "PUT",
            url: "/api/members/password/" + memberId,
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Content-type", "application/json");
                xhr.setRequestHeader("X-AUTH-TOKEN", accessToken);
            },
            contentType: "application/json",
            data: JSON.stringify(passwordUpdateDto),
            async: false,
            statusCode: {
                200: function (response) { //성공
                    alert(response.message);
                    console.log("Update password success.");
                    console.log("Logout.");
                    console.log("Delete tokens.");
                    storageClear();
                    console.log("Go to login form.");
                    $(location).attr('href', '/members/login');
                },
                403: function () { // Access fail
                    console.log("Access fail.");
                    let refreshResult = refresh(refreshToken);

                    if (refreshResult.state == 200) {
                        console.log("Try again update password!!");
                        updatePassword(refreshResult.memberId, refreshResult.accessToken, refreshResult.refreshToken, newPassword, oldPassword);
                    } else {
                        ifRefreshFail();
                    }
                },
                400: function (response) { // 변경할 비밀번호 및 기존 비밀번호를 입력하지 않은 경우, 기존 비밀번호를 틀린 경우
                                   // 비밀번호를 입력하지 않은 경우는 별도로 막아놓음 -> 기존 비밀번호를 틀렸을 경우에 대한 처리만 구현
                    let responseJson = JSON.parse(response.responseText);
                    alert(responseJson.message);
                    console.log("Clear updatePasswordConfirmPassword.");
                    $('#updatePasswordConfirmPassword').val("");
                },
                401: function (response) { // 다른 회원의 비밀번호를 변경하는 경우
                    let responseJson = JSON.parse(response.responseText);
                    alert(responseJson.message);
                }
            }
        });
    }

    function getPasswordValues() {
        let newPassword = $('#newPassword').val();
        let newPasswordConfirm = $('#newPasswordConfirm').val();
        let updatePasswordConfirmPassword = $('#updatePasswordConfirmPassword').val();

        return {
            newPassword: newPassword,
            newPasswordConfirm: newPasswordConfirm,
            updatePasswordConfirmPassword: updatePasswordConfirmPassword
        }
    }

    function checkIfPasswordUpdateIsPossible(newPassword, newPasswordConfirm, updatePasswordConfirmPassword) {
        let existFlag = checkExistPasswords(newPassword, newPasswordConfirm, updatePasswordConfirmPassword);
        let matchFlag = checkNewPasswordAndNewPasswordConfirmMatch(newPassword, newPasswordConfirm);
        let possibleFlag = existFlag && matchFlag;

        console.log("existFlag = " + existFlag);
        console.log("matchFlag = " + matchFlag);
        console.log("possibleFlag = " + possibleFlag);

        if (matchFlag == false) {
            alert("변경할 비밀번호가 서로 다릅니다. 다시 한번 확인해 주세요.");
        }

        if (existFlag == false) {
            alert("비밀번호를 모두 기입해 주세요.");
        }

        return possibleFlag;
    }

    function checkNewPasswordAndNewPasswordConfirmMatch(newPassword, newPasswordConfirm) {
        return newPassword == newPasswordConfirm ? true : false;
    }

    function checkExistPasswords(newPassword, newPasswordConfirm, updatePasswordConfirmPassword) {
        let existFlag = true;

        if (!checkExistPassword(newPassword)) {
            existFlag = false;
        }
        if (!checkExistPassword(newPasswordConfirm)) {
            existFlag = false;
        }
        if (!checkExistPassword(updatePasswordConfirmPassword)) {
            existFlag = false;
        }

        return existFlag;
    }

    function checkExistPassword(password) {
        if (password == "" || password == " ") {
            return false;
        }

        return true;
    }
</script>

<style>
    .custom-text-box {
        border: 2px solid #e3e6f0;
        border-radius: 1em;
    }

    .custom-text-box:focus {
        box-shadow: 0 0 5pt 2pt #D3D3D3;
        outline-width: 0px;
    }
</style>
</body>
</html>