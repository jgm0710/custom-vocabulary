<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Shared Vocabulary</title>
</head>
<body>
<th:block th:include="fragments/header"/>
<div class="card">
    <div class="card-header">
        Profile
    </div>
    <ul class="list-group list-group-flush">
        <li class="list-group-item">
            <div class="row">
                <div class="col">No.</div>
                <input id="memberId" class="col-10 custom-text-box read-toggle" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">Login ID</div>
                <input id="joinId" class="col-10 custom-text-box read-toggle" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">Email</div>
                <input id="email" class="col-10 custom-text-box read-toggle" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">name</div>
                <input id="name" class="col-10 custom-text-box read-toggle" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">Nickname</div>
                <input id="nickname" class="col-10 custom-text-box read-toggle" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div id="textDateOfBirth">
                <div class="row">
                    <div class="col-2">생년월일</div>
                    <input id="dateOfBirth" class="col custom-text-box" type="text" readonly>
                </div>
            </div>

            <div id="selectDateOfBirth" style="display: none">
                <div class="row">
                    <div class="col-2">
                        <span class="custom-span">생년월일</span>
                    </div>
                    <div class="col-md-auto">
                        <select name="year"
                                class="form-select form-select-sm"
                                aria-label=".form-select-sm example">
                            <option selected value="-1">year</option>
                            <th:block th:each="num: ${years}">
                                <option th:value="${num}" th:text="${num}" value="1"></option>
                            </th:block>
                        </select>
                    </div>
                    <div class="col-md-auto">
                        <select name="month"
                                class="form-select form-select-sm"
                                aria-label=".form-select-sm example">
                            <option selected value="-1">month</option>
                            <th:block th:each="month: ${month}">
                                <option th:value="${month.value}" th:text="${month.text}"
                                        value="1"></option>
                            </th:block>
                        </select>
                    </div>
                    <div class="col-md-auto">
                        <select name="day"
                                class="form-select form-select-sm"
                                aria-label=".form-select-sm example">
                            <option selected value="-1">day</option>
                            <th:block th:each="day: ${days}">
                                <option th:value="${day.value}" th:text="${day.text}"
                                        value="1"></option>
                            </th:block>
                        </select>
                    </div>
                </div>
            </div>
        </li>
        <li class="list-group-item">
            <div id="textGender">
                <div class="row">
                    <div class="col">성별</div>
                    <input id="gender" class="col-10 custom-text-box" type="text" readonly>
                    <div style="display: none">
                        <input class="col-10 custom-text-box" type="text" readonly>
                    </div>
                </div>
            </div>

            <div id="selectGender" style="display: none">
                <div class="row">
                    <div class="col-2">
                        <span class="custom-span">성별</span>
                    </div>
                    <div class="col-md-auto">
                        <select name="gender"
                                class="form-select form-select-sm"
                                aria-label=".form-select-sm example">
                            <option selected value="-1">Gender</option>
                            <option th:value="MALE" th:text="남성" value="MALE"></option>
                            <option th:value="FEMALE" th:text="여성" value="FEMALE"></option>
                        </select>
                    </div>
                </div>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">Simple Address</div>
                <input id="simpleAddress" class="col-10 custom-text-box read-toggle" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">공유한 단어장 수</div>
                <input id="sharedVocabularyCount" class="col-10 custom-text-box" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">작성한 게시글 수</div>
                <input id="bbsCount" class="col-10 custom-text-box" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">가입일시</div>
                <input id="registerDate" class="col-10 custom-text-box" type="text" readonly>
            </div>
        </li>
        <li class="list-group-item">
            <div class="row">
                <div class="col">개인정보 최종 수정일시</div>
                <input id="updateDate" class="col-10 custom-text-box" type="text" readonly>
            </div>
        </li>
    </ul>
</div>
<div id="custom-button-group" style="margin-top: 10px">
    <input id="modify-btn" type="button" value="Modify" class="btn btn-outline-warning">
    <input id="withdrawal-btn" type="button" value="Withdrawal" class="btn btn-outline-danger" data-bs-toggle="modal"
           data-bs-target="#withdrawalConfirmationModal">
    <input id="update-password-btn" type="button" class="btn btn-outline-secondary" value="Update Password">
    <input id="cancel-btn" type="hidden" value="Cancel" class="btn btn-outline-warning">
    <input id="confirm-btn" type="hidden" class="btn btn-outline-success" value="Confirm" data-bs-toggle="modal"
           data-bs-target="#modifyConfirmationModal">
</div>

<!-- Modify confirmation modal -->
<div class="modal fade" id="modifyConfirmationModal" tabindex="-1" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">프로필 수정 본인인증</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                본인 확인을 위한 비밀번호를 입력해주세요.
            </div>
            <div class="input-group input-group-sm mb-3">
                <input id="modifyConfirmPassword" type="password" class="form-control ml-3 mr-3"
                       aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="modify-confirm-btn" type="button" class="btn btn-primary">Modify confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Withdrawal confirmation modal -->
<div class="modal fade" id="withdrawalConfirmationModal" tabindex="-1" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel2">회원탈퇴 본인인증</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                본인 확인을 위한 비밀번호를 입력해주세요.
            </div>
            <div class="input-group input-group-sm mb-3">
                <input id="withdrawalConfirmPassword" type="password" class="form-control ml-3 mr-3"
                       aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="withdrawal-confirm-btn" type="button" class="btn btn-primary">Withdrawal confirm</button>
            </div>
        </div>
    </div>
</div>

<th:block th:include="fragments/footer"/>

<script th:src="@{/custom/profile.js}"></script>
<script>
    $(document).ready(function () {

        let tokenInfo = getTokenInfo();

        if (tokenInfo.accessToken == null) {
            $(location).attr('href', '/');
            localStorage.clear();
            alert("인증되지 않은 회원은 프로필에 접근할 수 없습니다.");
        }

        let profile = getProfile(tokenInfo.memberId, tokenInfo.accessToken, tokenInfo.refreshToken);

        fillInProfile(profile);

        $('#modify-btn').click(function () {
            switchToModifyMode();
        });

        $('#cancel-btn').click(function () {
            switchToNormalMode();
            fillInProfile(profile);
        });

        $('#modify-confirm-btn').click(function () {
            let updateDto = getUpdateDto();
            modifyProfile(tokenInfo.memberId, tokenInfo.accessToken + "i", tokenInfo.refreshToken, updateDto);
        });

        $('#withdrawal-confirm-btn').click(function () {
            console.log("Click withdrawal confirm button.");
            const confirmPassword = $('#withdrawalConfirmPassword').val();
            if (checkExistConfirmPassword(confirmPassword)) {
                withdrawal(tokenInfo.memberId, tokenInfo.accessToken+"i", tokenInfo.refreshToken, confirmPassword);
            }
        });

    });

    function withdrawal(memberId, accessToken, refreshToken, confirmPassword) {
        const onlyPasswordDto = {
            password: confirmPassword
        };

        $.ajax({
            method: "DELETE",
            url: "/api/members/secession/" + memberId,
            async: false,
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Content-type", "application/json");
                xhr.setRequestHeader("X-AUTH-TOKEN", accessToken);
            },
            contentType: "application/json",
            data: JSON.stringify(onlyPasswordDto),
            statusCode: {
                200: function (response) { //회원탈퇴 성공
                    console.log("Withdrawal success.");
                    console.log("Delete tokens");
                    storageClear();

                    console.log("Go to home.");
                    alert("회원 탈퇴가 정상적으로 완료되었습니다.");
                    $(location).attr('href', '/');
                },
                403: function () { // Access 실패
                    console.log("Withdrawal access fail.");
                    let refreshResult = refresh(refreshToken);
                    if (refreshResult.state == 200) {
                        console.log("Try again withdrawal.");
                        withdrawal(refreshResult.memberId, refreshResult.accessToken, refreshResult.refreshToken, confirmPassword);
                    } else {
                        ifRefreshFail();
                    }
                },
                400: function (response) { // 본인확인 비밀번호 틀림
                    let responseJson = JSON.parse(response.responseText);
                    $('#withdrawalConfirmPassword').val("");
                    alert(responseJson.message);
                },
                401: function (response) { // 다른 회원의 탈퇴를 요청하는 경우
                    let responseJson = JSON.parse(response.responseText);
                    alert(responseJson.message);
                }
            }
        });
    }
</script>

<style>
    .custom-text-box {
        border: 2px solid #e3e6f0;
        border-radius: 1em;
    }

    .custom-text-box:focus {
        box-shadow: 0 0 5pt 2pt #D3D3D3;
        outline-width: 0px;
    }
</style>
</body>
</html>